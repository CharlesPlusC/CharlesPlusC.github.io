name: Bootstrap TLE Density Data (Initial Historical Load)

on:
  workflow_dispatch: # Manual trigger only
    inputs:
      days_history:
        description: 'Number of days of historical data to fetch'
        required: false
        default: '365'
        type: string

jobs:
  bootstrap-density:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests numpy

      - name: Fetch historical TLEs from Space-Track and calculate densities
        env:
          SPACETRACK_USER: ${{ secrets.SPACETRACK_USER }}
          SPACETRACK_PASS: ${{ secrets.SPACETRACK_PASS }}
          DAYS_HISTORY: ${{ github.event.inputs.days_history }}
        run: |
          python3 << 'EOF'
          import requests
          import json
          import numpy as np
          from datetime import datetime, timedelta, timezone
          import os
          import time

          # Constants
          MU = 398600.4418e9       # Earth's gravitational parameter in m³/s²
          R_EARTH = 6378137.0      # Earth radius in m

          # Satellite configurations
          SATELLITES = {
              # Original satellites
              '22': {'name': 'Explorer 7', 'cd': 2.2, 'area': 0.5, 'mass': 41.0},
              '43476': {'name': 'GRACE-FO-A', 'cd': 2.2, 'area': 3.0, 'mass': 580.0},
              '43877': {'name': 'Kanopus-V 6', 'cd': 2.2, 'area': 2.0, 'mass': 500.0},
              '62407': {'name': 'Electron Kick Stage R/B', 'cd': 2.2, 'area': 3.0, 'mass': 200.0},
              '54695': {'name': 'Jilin-1 Gaofen 03D48', 'cd': 2.2, 'area': 0.7, 'mass': 40.0},
              '54686': {'name': 'Dongpo 08', 'cd': 2.2, 'area': 0.6, 'mass': 30.0},
              '60012': {'name': 'Object A', 'cd': 2.2, 'area': 1.0, 'mass': 60.0},
              '39212': {'name': 'CZ-4C DEB', 'cd': 2.2, 'area': 1.0, 'mass': 50.0},
              # New debris objects (350-650 km altitude spread)
              # COSMOS 1408 debris (2021 Russian ASAT test)
              '50058': {'name': 'COSMOS 1408 DEB (50058)', 'cd': 2.2, 'area': 0.5, 'mass': 20.0},
              '50621': {'name': 'COSMOS 1408 DEB (50621)', 'cd': 2.2, 'area': 0.5, 'mass': 20.0},
              '50404': {'name': 'COSMOS 1408 DEB (50404)', 'cd': 2.2, 'area': 0.5, 'mass': 20.0},
              # COSMOS 2251 debris (2009 Iridium-Cosmos collision)
              '33815': {'name': 'COSMOS 2251 DEB (33815)', 'cd': 2.2, 'area': 0.5, 'mass': 20.0},
              '33821': {'name': 'COSMOS 2251 DEB (33821)', 'cd': 2.2, 'area': 0.5, 'mass': 20.0},
              '33818': {'name': 'COSMOS 2251 DEB (33818)', 'cd': 2.2, 'area': 0.5, 'mass': 20.0},
              '33799': {'name': 'COSMOS 2251 DEB (33799)', 'cd': 2.2, 'area': 0.5, 'mass': 20.0},
              # IRIDIUM 33 debris (2009 Iridium-Cosmos collision)
              '34488': {'name': 'IRIDIUM 33 DEB (34488)', 'cd': 2.2, 'area': 0.5, 'mass': 20.0},
              '34693': {'name': 'IRIDIUM 33 DEB (34693)', 'cd': 2.2, 'area': 0.5, 'mass': 20.0},
              '35622': {'name': 'IRIDIUM 33 DEB (35622)', 'cd': 2.2, 'area': 0.5, 'mass': 20.0},
              '40996': {'name': 'IRIDIUM 33 DEB (40996)', 'cd': 2.2, 'area': 0.5, 'mass': 20.0},
              '34088': {'name': 'IRIDIUM 33 DEB (34088)', 'cd': 2.2, 'area': 0.5, 'mass': 20.0},
              '33960': {'name': 'IRIDIUM 33 DEB (33960)', 'cd': 2.2, 'area': 0.5, 'mass': 20.0},
              '35744': {'name': 'IRIDIUM 33 DEB (35744)', 'cd': 2.2, 'area': 0.5, 'mass': 20.0},
              '33860': {'name': 'IRIDIUM 33 DEB (33860)', 'cd': 2.2, 'area': 0.5, 'mass': 20.0},
              '34077': {'name': 'IRIDIUM 33 DEB (34077)', 'cd': 2.2, 'area': 0.5, 'mass': 20.0},
              '34652': {'name': 'IRIDIUM 33 DEB (34652)', 'cd': 2.2, 'area': 0.5, 'mass': 20.0},
              '33881': {'name': 'IRIDIUM 33 DEB (33881)', 'cd': 2.2, 'area': 0.5, 'mass': 20.0},
              '34366': {'name': 'IRIDIUM 33 DEB (34366)', 'cd': 2.2, 'area': 0.5, 'mass': 20.0},
              '35051': {'name': 'IRIDIUM 33 DEB (35051)', 'cd': 2.2, 'area': 0.5, 'mass': 20.0},
              '33773': {'name': 'IRIDIUM 33 DEB (33773)', 'cd': 2.2, 'area': 0.5, 'mass': 20.0},
              '35620': {'name': 'IRIDIUM 33 DEB (35620)', 'cd': 2.2, 'area': 0.5, 'mass': 20.0},
              '33776': {'name': 'IRIDIUM 33 DEB (33776)', 'cd': 2.2, 'area': 0.5, 'mass': 20.0},
              '38228': {'name': 'IRIDIUM 33 DEB (38228)', 'cd': 2.2, 'area': 0.5, 'mass': 20.0},
              '35680': {'name': 'IRIDIUM 33 DEB (35680)', 'cd': 2.2, 'area': 0.5, 'mass': 20.0}
          }

          # Space-Track API
          SPACETRACK_URL = "https://www.space-track.org"
          LOGIN_URL = f"{SPACETRACK_URL}/ajaxauth/login"

          def parse_mean_motion(line2):
              """Extract mean motion from TLE line 2 (revs per day)"""
              return float(line2[52:63])

          def parse_mean_motion_derivative(line1):
              """Extract mean motion first derivative from TLE line 1 (revs per day²)"""
              raw = line1[33:43].strip()
              return float(raw)

          def parse_eccentricity(line2):
              """Extract eccentricity from TLE line 2"""
              return float("0." + line2[26:33])

          def tle_epoch_to_datetime(line1):
              """Convert TLE epoch to datetime"""
              epoch = line1[18:32]
              year_2digit = int(epoch[:2])
              year = 2000 + year_2digit if year_2digit < 57 else 1900 + year_2digit
              day = float(epoch[2:])
              dt = datetime(year, 1, 1, tzinfo=timezone.utc) + timedelta(days=day - 1)
              return dt

          def calculate_density_and_orbit(line1, line2, cd, area, mass):
              """Calculate atmospheric density and orbital parameters from TLE"""
              try:
                  epoch = tle_epoch_to_datetime(line1)
                  N = parse_mean_motion(line2)
                  N_dot = parse_mean_motion_derivative(line1)

                  n = N * 2 * np.pi / 86400.0
                  n_dot = N_dot * 2 * np.pi / (86400.0**2)

                  a = (MU / n**2)**(1/3)
                  e = parse_eccentricity(line2)
                  perigee_alt = (a * (1 - e) - R_EARTH) / 1000
                  apogee_alt = (a * (1 + e) - R_EARTH) / 1000

                  if perigee_alt < 100 or perigee_alt > 2000:
                      return None

                  v = np.sqrt(MU / a)
                  rho = (2 * mass * n_dot) / (3 * cd * area * n * v)

                  if rho < 0:
                      return None

                  return {
                      'epoch': epoch.isoformat(),
                      'density': float(rho),
                      'perigee': float(perigee_alt),
                      'apogee': float(apogee_alt),
                      'sma': float(a / 1000)
                  }
              except Exception as e:
                  return None

          def fetch_tles_from_spacetrack(session, norad_id, start_date, end_date):
              """Fetch TLE history from Space-Track API"""
              tles = []

              # Format dates for Space-Track query
              start_str = start_date.strftime("%Y-%m-%d")
              end_str = end_date.strftime("%Y-%m-%d")

              # Query GP history
              query_url = (
                  f"{SPACETRACK_URL}/basicspacedata/query/class/gp_history"
                  f"/NORAD_CAT_ID/{norad_id}"
                  f"/EPOCH/{start_str}--{end_str}"
                  f"/orderby/EPOCH%20asc/format/tle"
              )

              print(f"    Fetching from Space-Track...")

              try:
                  response = session.get(query_url, timeout=120)
                  if response.status_code == 200:
                      lines = response.text.strip().split('\n')
                      # Parse TLE pairs
                      i = 0
                      while i < len(lines) - 1:
                          line1 = lines[i].strip()
                          line2 = lines[i + 1].strip()
                          if line1.startswith('1 ') and line2.startswith('2 '):
                              tles.append((line1, line2))
                              i += 2
                          else:
                              i += 1
                      print(f"    Retrieved {len(tles)} TLEs from Space-Track")
                  else:
                      print(f"    Space-Track returned status {response.status_code}")
                      if response.status_code == 401:
                          print("    Authentication failed - check SPACETRACK_USER and SPACETRACK_PASS secrets")
              except Exception as e:
                  print(f"    Error fetching from Space-Track: {e}")

              return tles

          def main():
              days_history = int(os.environ.get('DAYS_HISTORY', '365'))
              spacetrack_user = os.environ.get('SPACETRACK_USER', '')
              spacetrack_pass = os.environ.get('SPACETRACK_PASS', '')

              print("=" * 60)
              print("TLE DENSITY BOOTSTRAP - HISTORICAL DATA LOADER")
              print(f"Fetching {days_history} days of historical TLE data")
              print("=" * 60)

              if not spacetrack_user or not spacetrack_pass:
                  print("\nERROR: Space-Track credentials not configured!")
                  print("Please add SPACETRACK_USER and SPACETRACK_PASS as repository secrets.")
                  print("You can register for a free account at https://www.space-track.org")
                  exit(1)

              os.makedirs('data', exist_ok=True)

              # Create session and login to Space-Track
              session = requests.Session()
              print("\nLogging in to Space-Track...")

              login_response = session.post(
                  LOGIN_URL,
                  data={'identity': spacetrack_user, 'password': spacetrack_pass}
              )

              if login_response.status_code != 200 or 'Failed' in login_response.text:
                  print(f"Login failed: {login_response.text}")
                  exit(1)

              print("Login successful!")

              end_date = datetime.now(timezone.utc)
              start_date = end_date - timedelta(days=days_history)

              for norad_id, sat_config in SATELLITES.items():
                  print(f"\nProcessing: {sat_config['name']} (NORAD {norad_id})")
                  print("-" * 40)

                  # Fetch historical TLE data
                  tles = fetch_tles_from_spacetrack(session, norad_id, start_date, end_date)

                  if not tles:
                      print(f"  No historical TLE data retrieved for {norad_id}")
                      # Create empty data file
                      data = {
                          'norad_id': norad_id,
                          'name': sat_config['name'],
                          'cd': sat_config['cd'],
                          'area': sat_config['area'],
                          'mass': sat_config['mass'],
                          'times': [],
                          'densities': [],
                          'perigees': [],
                          'apogees': [],
                          'smas': [],
                          'generated_at': datetime.now(timezone.utc).isoformat()
                      }
                      output_file = f"data/density-{norad_id}.json"
                      with open(output_file, 'w') as f:
                          json.dump(data, f)
                      continue

                  # Process TLEs
                  data = {
                      'times': [],
                      'densities': [],
                      'perigees': [],
                      'apogees': [],
                      'smas': []
                  }

                  seen_epochs = set()
                  for line1, line2 in tles:
                      result = calculate_density_and_orbit(
                          line1, line2,
                          sat_config['cd'],
                          sat_config['area'],
                          sat_config['mass']
                      )

                      if result and result['epoch'] not in seen_epochs:
                          seen_epochs.add(result['epoch'])
                          data['times'].append(result['epoch'])
                          data['densities'].append(result['density'])
                          data['perigees'].append(result['perigee'])
                          data['apogees'].append(result['apogee'])
                          data['smas'].append(result['sma'])

                  print(f"  Processed {len(data['times'])} valid data points")

                  # Sort by time
                  if data['times']:
                      combined = list(zip(
                          data['times'],
                          data['densities'],
                          data['perigees'],
                          data['apogees'],
                          data['smas']
                      ))
                      combined.sort(key=lambda x: x[0])

                      data['times'] = [x[0] for x in combined]
                      data['densities'] = [x[1] for x in combined]
                      data['perigees'] = [x[2] for x in combined]
                      data['apogees'] = [x[3] for x in combined]
                      data['smas'] = [x[4] for x in combined]

                  # Add metadata
                  data['norad_id'] = norad_id
                  data['name'] = sat_config['name']
                  data['cd'] = sat_config['cd']
                  data['area'] = sat_config['area']
                  data['mass'] = sat_config['mass']
                  data['generated_at'] = datetime.now(timezone.utc).isoformat()

                  # Save results
                  output_file = f"data/density-{norad_id}.json"
                  with open(output_file, 'w') as f:
                      json.dump(data, f)
                  print(f"  Saved to {output_file}")

                  # Rate limiting - Space-Track asks for reasonable request rates
                  time.sleep(2)

              # Logout
              session.get(f"{SPACETRACK_URL}/ajaxauth/logout")

              print("\n" + "=" * 60)
              print("Bootstrap complete!")
              print("=" * 60)

          if __name__ == "__main__":
              main()
          EOF

      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/density-*.json

          if git diff --staged --quiet; then
            echo "No changes to density data"
          else
            git commit -m "Bootstrap TLE density historical data [automated]"
            git push
            echo "Pushed bootstrapped density data"
          fi
