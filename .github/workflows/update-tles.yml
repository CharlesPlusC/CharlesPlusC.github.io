name: Update Satellite TLEs

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-tles:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Fetch TLE data from Celestrak
        run: |
          python3 << 'EOF'
          import requests
          import json
          from datetime import datetime, timezone

          # NOAA satellites
          satellites = [
              {'name': 'NOAA 15', 'frequency': '137.620 MHz', 'noradId': 25338},
              {'name': 'NOAA 18', 'frequency': '137.9125 MHz', 'noradId': 28654},
              {'name': 'NOAA 19', 'frequency': '137.100 MHz', 'noradId': 33591}
          ]

          tle_data = {}

          for sat in satellites:
              try:
                  url = f"https://celestrak.org/NORAD/elements/gp.php?CATNR={sat['noradId']}&FORMAT=TLE"
                  response = requests.get(url, timeout=10)
                  response.raise_for_status()

                  lines = response.text.strip().split('\n')

                  if len(lines) >= 3:
                      tle_data[str(sat['noradId'])] = {
                          'name': sat['name'],
                          'frequency': sat['frequency'],
                          'tle_line1': lines[1].strip(),
                          'tle_line2': lines[2].strip(),
                          'fetched_at': datetime.now(timezone.utc).isoformat()
                      }
                      print(f"✓ Fetched TLE for {sat['name']}")
                  else:
                      print(f"✗ Invalid TLE format for {sat['name']}")

              except Exception as e:
                  print(f"✗ Error fetching {sat['name']}: {e}")

          # Save to file
          output = {
              'satellites': tle_data,
              'updated_at': datetime.now(timezone.utc).isoformat(),
              'source': 'Celestrak'
          }

          with open('data/tles.json', 'w') as f:
              json.dump(output, f, indent=2)

          print(f"\n✓ Saved TLE data for {len(tle_data)} satellites to data/tles.json")
          EOF

      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/tles.json

          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to TLE data"
          else
            git commit -m "Update satellite TLEs from Celestrak [automated]"
            git push
            echo "✓ Pushed updated TLE data"
          fi
