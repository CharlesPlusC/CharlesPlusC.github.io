name: Update Satellite Passes

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-passes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests skyfield numpy

      - name: Fetch TLEs and calculate satellite passes
        run: |
          python3 << 'EOF'
          import requests
          import json
          from datetime import datetime, timedelta, timezone
          from skyfield.api import load, wgs84, EarthSatellite

          # Observer locations
          LOCATIONS = [
              {'name': 'London, UK', 'lat': 51.5074, 'lon': -0.1278, 'alt': 0, 'slug': 'london'},
              {'name': 'Paris, France', 'lat': 48.8566, 'lon': 2.3522, 'alt': 0, 'slug': 'paris'},
              {'name': 'Boulder, CO, USA', 'lat': 40.0150, 'lon': -105.2705, 'alt': 1655, 'slug': 'boulder'},
              {'name': 'Los Angeles, CA, USA', 'lat': 34.0522, 'lon': -118.2437, 'alt': 0, 'slug': 'los-angeles'},
              {'name': 'Reykjavik, Iceland', 'lat': 64.1466, 'lon': -21.9426, 'alt': 0, 'slug': 'reykjavik'},
              {'name': 'Brussels, Belgium', 'lat': 50.8503, 'lon': 4.3517, 'alt': 0, 'slug': 'brussels'},
              {'name': 'Lisbon, Portugal', 'lat': 38.7223, 'lon': -9.1393, 'alt': 0, 'slug': 'lisbon'},
              {'name': 'Biarritz, France', 'lat': 43.4832, 'lon': -1.5586, 'alt': 0, 'slug': 'biarritz'},
              {'name': 'New York, NY, USA', 'lat': 40.7128, 'lon': -74.0060, 'alt': 0, 'slug': 'new-york'}
          ]

          # NOAA satellites
          satellites = [
              {'name': 'NOAA 15', 'frequency': '137.620 MHz', 'noradId': 25338},
              {'name': 'NOAA 18', 'frequency': '137.9125 MHz', 'noradId': 28654},
              {'name': 'NOAA 19', 'frequency': '137.100 MHz', 'noradId': 33591}
          ]

          print("="*60)
          print("SATELLITE PASS CALCULATOR")
          print("="*60)

          # Load timescale
          ts = load.timescale()

          # Time range for predictions (next 7 days)
          t0 = ts.now()
          t1 = ts.utc(t0.utc_datetime() + timedelta(days=7))

          # Fetch TLEs once for all satellites
          print("\nFetching TLE data from Celestrak...")
          tle_cache = {}

          for sat_info in satellites:
              try:
                  url = f"https://celestrak.org/NORAD/elements/gp.php?CATNR={sat_info['noradId']}&FORMAT=TLE"
                  response = requests.get(url, timeout=10)
                  response.raise_for_status()

                  lines = response.text.strip().split('\n')

                  if len(lines) >= 3:
                      tle_cache[sat_info['noradId']] = {
                          'name': sat_info['name'],
                          'frequency': sat_info['frequency'],
                          'line1': lines[1],
                          'line2': lines[2]
                      }
                      print(f"  ✓ Fetched TLE for {sat_info['name']}")
                  else:
                      print(f"  ✗ Invalid TLE format for {sat_info['name']}")

              except Exception as e:
                  print(f"  ✗ Error fetching {sat_info['name']}: {e}")

          if len(tle_cache) == 0:
              print("\n✗ CRITICAL: Failed to fetch any TLE data from Celestrak!")
              exit(1)

          print(f"\n✓ Successfully fetched TLE data for {len(tle_cache)}/{len(satellites)} satellites")

          # Calculate passes for each location
          for location in LOCATIONS:
              print(f"\n{'='*60}")
              print(f"Processing: {location['name']}")
              print(f"Coordinates: {location['lat']:.4f}°, {location['lon']:.4f}° at {location['alt']}m")
              print(f"{'='*60}")

              observer = wgs84.latlon(location['lat'], location['lon'], elevation_m=location['alt'])
              result = {}

              for norad_id, tle_data in tle_cache.items():
                  try:
                      satellite = EarthSatellite(tle_data['line1'], tle_data['line2'], tle_data['name'], ts)
                      t, events = satellite.find_events(observer, t0, t1, altitude_degrees=10.0)

                      passes = []
                      current_pass = {}

                      for ti, event in zip(t, events):
                          if event == 0:
                              current_pass = {
                                  'start': ti.utc_iso(),
                                  'start_time': ti,
                                  'start_timestamp': ti.utc_datetime().timestamp()
                              }
                          elif event == 1:
                              if current_pass:
                                  difference = satellite - observer
                                  topocentric = difference.at(ti)
                                  alt_deg, az_deg, distance = topocentric.altaz()
                                  current_pass['max_elevation'] = round(alt_deg.degrees, 1)
                                  current_pass['max_elevation_time'] = ti.utc_iso()
                          elif event == 2:
                              if current_pass and 'start_time' in current_pass:
                                  current_pass['end'] = ti.utc_iso()
                                  current_pass['end_timestamp'] = ti.utc_datetime().timestamp()
                                  duration_secs = current_pass['end_timestamp'] - current_pass['start_timestamp']
                                  current_pass['duration'] = round(duration_secs / 60)

                                  if 'max_elevation' in current_pass:
                                      track = []
                                      start_dt = current_pass['start_time'].utc_datetime()
                                      num_points = min(int(duration_secs / 20) + 1, 30)
                                      for p in range(num_points + 1):
                                          sample_dt = start_dt + timedelta(seconds=duration_secs * p / num_points)
                                          sample_t = ts.utc(sample_dt.year, sample_dt.month, sample_dt.day,
                                                           sample_dt.hour, sample_dt.minute, sample_dt.second + sample_dt.microsecond/1e6)
                                          topo = (satellite - observer).at(sample_t)
                                          alt, az, _ = topo.altaz()
                                          track.append([round(az.degrees, 1), round(alt.degrees, 1)])
                                      current_pass['track'] = track

                                      del current_pass['start_time']
                                      del current_pass['start_timestamp']
                                      del current_pass['end_timestamp']
                                      passes.append(current_pass)

                              current_pass = {}

                      result[str(norad_id)] = {
                          'name': tle_data['name'],
                          'frequency': tle_data['frequency'],
                          'passes': passes
                      }

                      print(f"  ✓ {tle_data['name']}: {len(passes)} passes")

                  except Exception as e:
                      print(f"  ✗ {tle_data['name']}: Error - {e}")
                      result[str(norad_id)] = {
                          'name': tle_data['name'],
                          'frequency': tle_data['frequency'],
                          'passes': [],
                          'error': str(e)
                      }

              # Save results for this location
              output = {
                  'success': True,
                  'location': {
                      'name': location['name'],
                      'lat': location['lat'],
                      'lon': location['lon'],
                      'alt': location['alt']
                  },
                  'satellites': result,
                  'generated_at': datetime.now(timezone.utc).isoformat(),
                  'valid_for': '7 days from generation time'
              }

              filename = f"data/passes-{location['slug']}.json"
              with open(filename, 'w') as f:
                  json.dump(output, f, indent=2)

              print(f"  ✓ Saved to {filename}")

          print(f"\n{'='*60}")
          print(f"✓ All locations processed successfully!")
          print(f"{'='*60}")
          EOF

      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/passes-*.json

          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to satellite pass data"
          else
            git commit -m "Update satellite pass predictions [automated]"
            git push
            echo "✓ Pushed updated pass predictions"
          fi
